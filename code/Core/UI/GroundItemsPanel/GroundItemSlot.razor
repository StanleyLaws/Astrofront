@namespace Astrofront
@using Sandbox
@using Sandbox.UI
@inherits Panel

<root class="ground-item-slot @(HasItem ? "has-item" : "empty") @ItemClass @(IsHovered ? "hover" : "")"
      onmouseover=@OnHoverEnter
      onmouseout=@OnHoverLeave>

    <div class="slot-icon" style="@IconStyle"></div>

    @if ( HasItem && Amount > 0 )
    {
        <div class="slot-stack">@($"x{Amount}")</div>
    }
</root>

@code
{
    public int SlotIndex { get; set; }

    public string ItemId { get; set; } = "";
    public int Amount { get; set; }
    public bool HasItem { get; set; }

    public bool IsHovered { get; set; }

    private string ItemClass => (HasItem && !string.IsNullOrEmpty(ItemId) && Amount > 0)
    ? ItemRegistry.GetUiClass( ItemId )
    : "type-empty";


    private string IconStyle
	{
		get
		{
			// ✅ reset dur quand vide (empêche l’icône fantôme)
			if ( !HasItem || string.IsNullOrEmpty( ItemId ) || Amount <= 0 )
				return "background-image: none;";

			var icon = ItemRegistry.Get( ItemId )?.Icon;

			// ✅ pas de fallback (comme tu veux)
			if ( string.IsNullOrEmpty( icon ) )
				return "background-image: none;";

			return $"background-image: url('{icon}');";
		}
	}


    private static int? DragOriginSlotIndex;
    private static GroundItemSlot CurrentHoverSlot;
    private static Vector2 _pressPos;
    private static RealTimeSince _sincePress;

    private void OnHoverEnter()
    {
        IsHovered = true;
        CurrentHoverSlot = this;
        StateHasChanged();
    }

    private void OnHoverLeave()
    {
        IsHovered = false;
        if ( CurrentHoverSlot == this )
            CurrentHoverSlot = null;

        StateHasChanged();
    }

    protected override void OnMouseDown( MousePanelEvent e )
    {
        base.OnMouseDown( e );

        if ( e.Button != "mouseleft" && e.Button != "mouseright" )
            return;

        _pressPos = Mouse.Position;
        _sincePress = 0;

        if ( e.Button == "mouseleft" && HasItem )
            DragOriginSlotIndex = SlotIndex;
    }

    protected override void OnMouseUp( MousePanelEvent e )
    {
        base.OnMouseUp( e );

        var btn = e.Button;
        if ( btn != "mouseleft" && btn != "mouseright" )
            return;

        var target = CurrentHoverSlot ?? this;
        var logicalIndex = target.SlotIndex;

        var dist = (Mouse.Position - _pressPos).Length;
        var isClick = dist < 5f && _sincePress < 0.4f;

        if ( btn == "mouseright" )
        {
            GroundItemsPanel.Instance?.OnSlotClick( logicalIndex, "mouseright" );
            DragOriginSlotIndex = null;
            return;
        }

        if ( btn == "mouseleft" )
        {
            if ( isClick )
            {
                GroundItemsPanel.Instance?.OnSlotClick( logicalIndex, "mouseleft" );
                DragOriginSlotIndex = null;
                return;
            }

            if ( DragOriginSlotIndex.HasValue )
            {
                var from = DragOriginSlotIndex.Value;
                var to = logicalIndex;

                if ( from != to )
                    GroundItemsPanel.Instance?.OnDragDrop( from, to );
            }

            DragOriginSlotIndex = null;
        }
    }
}
