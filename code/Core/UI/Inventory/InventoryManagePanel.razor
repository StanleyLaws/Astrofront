@namespace Astrofront
@using Sandbox
@using System.Linq
@inherits PanelComponent

@if ( !IsOpen )
{
    return;
}

<div class="invmanage-root">
    <div class="invmanage-header">
        <span class="title">Inventaire</span>
    </div>

    <div class="invmanage-bar">
        @for ( int i = 0; i < _slotCount; i++ )
        {
            var isHands = (i == 0);

            var slot = _slots[i];
            var itemId = slot.ItemId;
            var amount = slot.Amount;

            var hasItem = !isHands && !string.IsNullOrEmpty( itemId ) && amount > 0;

            <InventoryManageSlot
                SlotIndex="@i"
                Locked="@isHands"
                HasItem="@hasItem"
                ItemId="@(hasItem ? itemId : "")"
                Amount="@(hasItem ? amount : 0)" />
        }
    </div>
</div>

@code
{
    public static InventoryManagePanel Instance { get; private set; }

    public bool IsOpen { get; private set; } = false;

    private InventoryComponent _inv;

    private int _slotCount = 5;

    private struct SlotView
    {
        public string ItemId;
        public int Amount;
    }

    private SlotView[] _slots = new SlotView[5];

    public InventoryManagePanel()
    {
        Instance = this;
    }

    protected override void OnStart()
    {
        BindLocalInventory();
        PullSlots();
    }

    protected override void OnUpdate()
    {
        if ( _inv == null )
        {
            BindLocalInventory();
            return;
        }
    }

    protected override void OnDestroy()
    {
        if ( _inv != null )
        {
            _inv.SelectionChanged -= OnSelectionChanged;
            _inv.SlotsChanged     -= OnSlotsChanged;
        }

        _inv = null;
    }

    private void BindLocalInventory()
    {
        if ( _inv != null ) return;

        var scene = Scene ?? Game.ActiveScene;
        if ( scene == null ) return;

        var ps = scene.GetAllComponents<PlayerState>()
            .FirstOrDefault( p => p != null
                              && !p.IsProxy
                              && p.GameObject != null
                              && (p.GameObject.Tags.Has("localplayer")
                                  || (Connection.Local != null && p.Network?.Owner == Connection.Local)) );

        if ( ps == null ) return;

        _inv = ps.GameObject.Components.Get<InventoryComponent>( FindMode.EverythingInSelfAndDescendants );
        if ( _inv == null ) return;

        _slotCount = _inv.SlotCount;
        _slots = new SlotView[_slotCount];

        _inv.SelectionChanged += OnSelectionChanged;
        _inv.SlotsChanged     += OnSlotsChanged;

        PullSlots();
        StateHasChanged();

        Log.Info( "[InventoryManagePanel] Bound InventoryComponent local owner." );
    }

    private void PullSlots()
    {
        if ( _inv == null ) return;

        var snap = _inv.GetSlotsSnapshot();
        if ( snap == null || snap.Count <= 0 ) return;

        _slotCount = snap.Count;

        if ( _slots == null || _slots.Length != _slotCount )
            _slots = new SlotView[_slotCount];

        for ( int i = 0; i < _slotCount; i++ )
        {
            var (id, amt) = snap[i];
            _slots[i] = new SlotView { ItemId = id ?? "", Amount = amt };
        }
    }

    private void OnSelectionChanged( int idx )
    {
        PullSlots();
        StateHasChanged();
    }

    private void OnSlotsChanged()
    {
        PullSlots();
        StateHasChanged();
    }

    // =========================
    // API appelée par les Slots
    // =========================

    public void OnDragDrop( int fromIndex, int toIndex )
    {
        if ( _inv == null ) return;

        if ( fromIndex == 0 || toIndex == 0 ) return;
        if ( fromIndex < 0 || toIndex < 0 || fromIndex >= _slotCount || toIndex >= _slotCount ) return;
        if ( fromIndex == toIndex ) return;

        _inv.RequestSwapHost( fromIndex, toIndex );
    }

    public void OnSlotPrimaryClick( int index )
    {
        if ( _inv == null ) return;
        if ( index == 0 ) return;
        if ( index < 0 || index >= _slotCount ) return;

        PullSlots();
        var slot = _slots[index];
        bool slotHasItem = !string.IsNullOrEmpty( slot.ItemId ) && slot.Amount > 0;

        // 1) Main vide -> prendre tout
        if ( !UiDragContext.HasItem )
        {
            if ( !slotHasItem ) return;

            UiDragContext.BeginHold( slot.ItemId, slot.Amount, UiDragSourceKind.Inventory, index );
            _inv.RequestTakeHost( index, slot.Amount );
            return;
        }

        // 2) Main pleine -> placer
        var heldId = UiDragContext.HeldItemId;
        var heldAmount = UiDragContext.HeldAmount;

        if ( heldAmount <= 0 || string.IsNullOrEmpty( heldId ) )
        {
            UiDragContext.Clear();
            return;
        }

        // Si la main vient du loot -> transaction serveur anti-dup
        if ( UiDragContext.SourceKind == UiDragSourceKind.LootPanel )
        {
            UiLootInventoryBridge.RequestLootToInventory( heldId, heldAmount, index );
            return;
        }

        // Main vient de l'inventaire :
        // - slot vide -> place tout
        if ( !slotHasItem )
        {
            _inv.RequestPlaceHost( index, heldId, heldAmount );
            UiDragContext.Clear();
            return;
        }

        // - même item -> merge (place tout, le host clamp maxstack)
        if ( slot.ItemId == heldId )
        {
            _inv.RequestPlaceHost( index, heldId, heldAmount );
            UiDragContext.Clear();
            return;
        }

        // - item différent -> swap main <-> slot :
        //   a) prendre tout du slot (devient nouvelle main)
        //   b) placer l'ancien held dans le slot
        var oldHeldId = heldId;
        var oldHeldAmt = heldAmount;

        UiDragContext.BeginHold( slot.ItemId, slot.Amount, UiDragSourceKind.Inventory, index );
        _inv.RequestTakeHost( index, slot.Amount );
        _inv.RequestPlaceHost( index, oldHeldId, oldHeldAmt );
    }

    public void OnSlotSecondaryClick( int index )
    {
        if ( _inv == null ) return;
        if ( index == 0 ) return;
        if ( index < 0 || index >= _slotCount ) return;

        PullSlots();
        var slot = _slots[index];
        bool slotHasItem = !string.IsNullOrEmpty( slot.ItemId ) && slot.Amount > 0;

        // 1) Main vide -> prendre 1
        if ( !UiDragContext.HasItem )
        {
            if ( !slotHasItem ) return;

            UiDragContext.BeginHold( slot.ItemId, 1, UiDragSourceKind.Inventory, index );
            _inv.RequestTakeHost( index, 1 );
            return;
        }

        // 2) Main pleine -> placer 1
        var heldId = UiDragContext.HeldItemId;
        var heldAmount = UiDragContext.HeldAmount;

        if ( heldAmount <= 0 || string.IsNullOrEmpty( heldId ) )
        {
            UiDragContext.Clear();
            return;
        }

        // Loot -> inventaire (1)
        if ( UiDragContext.SourceKind == UiDragSourceKind.LootPanel )
        {
            UiLootInventoryBridge.RequestLootToInventory( heldId, 1, index );
            return;
        }

        // Inventaire -> inventaire : place 1 si slot vide ou même item
        if ( !slotHasItem || slot.ItemId == heldId )
        {
            _inv.RequestPlaceHost( index, heldId, 1 );
            UiDragContext.TakeFromHand( 1 );
            return;
        }

        // slot différent : on ne fait rien en secondaire
    }

    // =========================
    // Ouverture / Fermeture
    // =========================
    public static void Show()
    {
        if ( Instance == null ) return;

        if ( Instance._inv == null )
            Instance.BindLocalInventory();

        Instance.PullSlots();
        Instance.IsOpen = true;
        Instance.StateHasChanged();
    }

    public static void Hide()
	{
		if ( Instance == null ) return;

		// ✅ Si on ferme avec une main "inventaire", on remet tout dans l'inventaire
		if ( Instance._inv != null
			 && UiDragContext.HasItem
			 && UiDragContext.SourceKind == UiDragSourceKind.Inventory )
		{
			Instance._inv.RequestRefundHeldHost(
				UiDragContext.HeldItemId,
				UiDragContext.HeldAmount,
				UiDragContext.SourceIndex
			);

			UiDragContext.Clear();
		}

		Instance.IsOpen = false;
		Instance.StateHasChanged();
	}

}
