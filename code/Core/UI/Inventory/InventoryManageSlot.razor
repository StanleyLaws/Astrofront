@namespace Astrofront
@using Sandbox
@using Sandbox.UI
@inherits Panel

<root class="invman-slot @(Locked ? "locked" : "") @(HasItem ? "has-item" : "empty") @ItemClass @(IsHovered ? "hover" : "")"
      onmouseover="@(Locked ? null : OnHoverEnter)"
      onmouseout="@(Locked ? null : OnHoverLeave)">

    <div class="slot-icon" style="@IconStyle"></div>

    @if ( !Locked && HasItem && Amount > 0 )
    {
        <div class="slot-stack">@($"x{Amount}")</div>
    }
</root>

@code
{
    public int SlotIndex { get; set; }
    public bool Locked { get; set; } = false;

    public bool HasItem { get; set; }
    public string ItemId { get; set; } = "";
    public int Amount { get; set; }

    public bool IsHovered { get; set; }

    private string ItemClass => Locked
        ? "type-hands"
        : (HasItem ? ItemRegistry.GetUiClass( ItemId ) : "type-empty");

    // ✅ L’icône vient de l’ItemDefinition.Icon (pas de mapping CSS)
    private string IconStyle
    {
        get
        {
            // Hands = icône hardcodée (exception)
            if ( Locked )
                return "background-image: url('/ui/icons/hands.png');";

            // Slot vide = on reset => plus de fantôme
            if ( !HasItem || string.IsNullOrEmpty( ItemId ) || Amount <= 0 )
                return "background-image: none;";

            var icon = ItemRegistry.Get( ItemId )?.Icon;

            if ( string.IsNullOrEmpty( icon ) )
                return "background-image: none;"; // pas de fallback demandé

            // IMPORTANT: url('...') pour être safe si chemins avec caractères spéciaux
            return $"background-image: url('{icon}');";
        }
    }

    private static int? DragOriginIndex;
    private static InventoryManageSlot CurrentHoverSlot;
    private static Vector2 _pressPos;
    private static RealTimeSince _sincePress;

    private void OnHoverEnter()
    {
        IsHovered = true;
        CurrentHoverSlot = this;
        StateHasChanged();
    }

    private void OnHoverLeave()
    {
        IsHovered = false;
        if ( CurrentHoverSlot == this )
            CurrentHoverSlot = null;

        StateHasChanged();
    }

    protected override void OnMouseDown( MousePanelEvent e )
    {
        base.OnMouseDown( e );
        if ( Locked ) return;

        if ( e.Button != "mouseleft" && e.Button != "mouseright" )
            return;

        _pressPos = Mouse.Position;
        _sincePress = 0;

        if ( e.Button == "mouseleft" && HasItem )
            DragOriginIndex = SlotIndex;
    }

    protected override void OnMouseUp( MousePanelEvent e )
    {
        base.OnMouseUp( e );
        if ( Locked ) return;

        var btn = e.Button;
        if ( btn != "mouseleft" && btn != "mouseright" )
            return;

        var target = CurrentHoverSlot ?? this;
        var logicalIndex = target.SlotIndex;

        var dist = (Mouse.Position - _pressPos).Length;
        var isClick = dist < 5f && _sincePress < 0.4f;

        if ( btn == "mouseright" )
        {
            InventoryManagePanel.Instance?.OnSlotSecondaryClick( logicalIndex );
            DragOriginIndex = null;
            return;
        }

        if ( btn == "mouseleft" )
        {
            if ( isClick )
            {
                InventoryManagePanel.Instance?.OnSlotPrimaryClick( logicalIndex );
                DragOriginIndex = null;
                return;
            }

            if ( DragOriginIndex.HasValue )
            {
                var from = DragOriginIndex.Value;
                var to = logicalIndex;

                if ( from != to )
                    InventoryManagePanel.Instance?.OnDragDrop( from, to );
            }

            DragOriginIndex = null;
        }
    }
}
