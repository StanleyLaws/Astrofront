@using Sandbox
@using System.Linq
@namespace Astrofront
@inherits PanelComponent

<root class="invquick-root @(_isVisible ? "visible" : "hidden")">

    <div class="invquick-weight">
        <div class="weight-bar">
            <div class="weight-fill @(Weight01 > 0.85f ? "heavy" : null)"
                 style="height: @(Weight01 * 100f)%">
            </div>
        </div>
        <div class="weight-text">@($"{WeightPercent}%")</div>
    </div>

    <div class="invquick-bar">
        @for ( int i = 0; i < _slotCount; i++ )
        {
            bool isHands = (i == 0);

            var slot   = _slots[i];
            var itemId = slot.ItemId;
            var amount = slot.Amount;

            bool hasItem = !isHands && !string.IsNullOrEmpty( itemId ) && amount > 0;

            bool isSelected = i == _selected;
            bool isRecent   = i == _prevSelected && _sincePrev < PrevHighlightDuration;

            string typeClass = isHands ? "type-hands" : (hasItem ? ItemRegistry.GetUiClass( itemId ) : "type-empty");
            string name      = isHands ? "HANDS" : (hasItem ? ItemRegistry.GetName( itemId ).ToUpperInvariant() : "");

            // ✅ Icône dynamique (asset Icon) :
			// - hands -> icône mains
			// - item  -> Icon asset sinon fallback
			// - empty -> rien
			string iconPath =
				isHands ? "/ui/icons/hands.png" :
				(hasItem ? (ItemRegistry.GetIcon( itemId ) ?? ItemRegistry.GetIconOrFallback( itemId )) : null);

			string iconStyle =
			isHands ? "background-image: url('/ui/icons/hands.png');" :
			(!hasItem ? "background-image: none;" :
			$"background-image: url('{ItemRegistry.GetIcon(itemId)}');");




            <div class="invquick-slot @(isSelected ? "selected" : null) @(isRecent ? "recent" : null) @(hasItem || isHands ? "has-item" : "empty") @typeClass">
                <div class="slot-icon" style="@iconStyle"></div>

                @if ( hasItem && amount > 0 )
                {
                    <div class="slot-stack">@($"x{amount}")</div>
                }

                @if ( hasItem || isHands )
                {
                    <div class="slot-name">@name</div>
                }

                <div class="slot-index">@((i + 1).ToString())</div>
            </div>
        }
    </div>
</root>

@code
{
    private InventoryComponent _inv;

    private int _slotCount = 5;
    private int _selected = 0;

    private struct HudSlot
    {
        public string ItemId;
        public int Amount;
    }

    private HudSlot[] _slots = new HudSlot[5];

    private bool _isVisible = false;
    private RealTimeSince _sinceShown;

    private int _prevSelected = -1;
    private RealTimeSince _sincePrev;

    private const float ShowDuration = 1.35f;
    private const float PrevHighlightDuration = 0.22f;

    protected override void OnStart()
    {
        TryBindLocalInventory();
    }

    protected override void OnUpdate()
    {
        if ( _inv == null )
        {
            TryBindLocalInventory();
            return;
        }

        if ( _isVisible && _sinceShown > ShowDuration )
        {
            _isVisible = false;
            StateHasChanged();
        }
    }

    protected override void OnDestroy()
    {
        if ( _inv != null )
        {
            _inv.SelectionChanged -= OnSelectionChanged;
            _inv.SlotsChanged     -= OnSlotsChanged;
        }
    }

    private void TryBindLocalInventory()
    {
        var scene = Scene ?? Game.ActiveScene;
        if ( scene == null ) return;

        var ps = scene.GetAllComponents<PlayerState>()
            .FirstOrDefault( p => p != null && !p.IsProxy && p.GameObject != null && p.GameObject.Tags.Has( "localplayer" ) );

        if ( ps == null )
        {
            var local = Connection.Local;
            if ( local != null )
            {
                ps = scene.GetAllComponents<PlayerState>()
                    .FirstOrDefault( p => p != null && !p.IsProxy && p.Network != null && p.Network.Owner == local );
            }
        }

        if ( ps == null ) return;

        _inv = ps.GameObject.Components.Get<InventoryComponent>( FindMode.EverythingInSelfAndDescendants );
        if ( _inv == null ) return;

        _slotCount = _inv.SlotCount;
        _selected  = _inv.SelectedIndex;

        PullSlots();

        _inv.SelectionChanged += OnSelectionChanged;
        _inv.SlotsChanged     += OnSlotsChanged;

        StateHasChanged();
    }

    private void PullSlots()
    {
        if ( _inv == null ) return;

        var list = _inv.GetSlotsSnapshot();
        if ( list == null || list.Count <= 0 ) return;

        _slotCount = list.Count;

        if ( _slots == null || _slots.Length != _slotCount )
            _slots = new HudSlot[_slotCount];

        for ( int i = 0; i < _slotCount; i++ )
        {
            var (id, amt) = list[i];
            _slots[i] = new HudSlot { ItemId = id, Amount = amt };
        }
    }

    private void ShowBar()
    {
        _isVisible = true;
        _sinceShown = 0;
    }

    private void OnSelectionChanged( int idx )
    {
        _prevSelected = _selected;
        _sincePrev = 0;

        _selected = idx;

        PullSlots();
        ShowBar();

        StateHasChanged();
    }

    private void OnSlotsChanged()
    {
        PullSlots();
        ShowBar();
        StateHasChanged();
    }

    private float Weight01
    {
        get
        {
            if ( _inv == null || _inv.CapacitySpace <= 0 ) return 0f;
            var used = _inv.UsedSpace();
            var v = (float)used / (float)_inv.CapacitySpace;
            return v.Clamp( 0f, 1f );
        }
    }

    private int WeightPercent => (int)(Weight01 * 100f);
}
