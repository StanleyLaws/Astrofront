@namespace Astrofront
@using Sandbox
@using Sandbox.UI
@attribute [StyleSheet]
@inherits PanelComponent

<div class="heldcursor-root">
    <div class="heldcursor-slot" style="@SlotStyle">
        <div class="slot-icon" style="@IconStyle"></div>
        <div class="slot-stack">@AmountLabel</div>
    </div>
</div>

@code
{
    private const float TargetScreenSize = 72f; // taille voulue en pixels écran
    private float _uiSize;                      // taille convertie en UI units

    private string HeldId => UiDragContext.HeldItemId;
    private int HeldAmount => UiDragContext.HeldAmount;

    private string AmountLabel => HeldAmount > 0 ? $"x{HeldAmount}" : "";

    private string SlotStyle => _uiSize > 0 ? $"width:{_uiSize}px;height:{_uiSize}px;" : "";

    private string IconStyle
    {
        get
        {
            // reset + taille
            var baseStyle = _uiSize > 0 ? $"width:{_uiSize}px;height:{_uiSize}px;background-image:none;" : "background-image:none;";

            if ( !UiDragContext.HasItem )
                return baseStyle;

            // HANDS (si tu l'utilises)
            if ( HeldId == "hands" )
                return baseStyle + "background-image:url('/ui/icons/hands.png');";

            // item normal => Icon depuis itemdef
            var icon = ItemRegistry.GetIcon( HeldId );
            if ( string.IsNullOrEmpty( icon ) )
                return baseStyle;

            return baseStyle + $"background-image:url('{icon}');";
        }
    }

    protected override void OnUpdate()
    {
        base.OnUpdate();

        if ( Panel == null )
            return;

        if ( !UiDragContext.HasItem )
        {
            Panel.Style.Display       = DisplayMode.None;
            Panel.Style.PointerEvents = PointerEvents.None;
            return;
        }

        Panel.Style.Display       = DisplayMode.Flex;
        Panel.Style.Position      = PositionMode.Absolute;
        Panel.Style.PointerEvents = PointerEvents.None;
        Panel.Style.ZIndex        = 999;

        // ✅ position stable toutes résolutions
        float s = Panel.ScaleFromScreen;

        var mouse = Mouse.Position;
        Panel.Style.Left = mouse.x * s;
        Panel.Style.Top  = mouse.y * s;

        // ✅ taille visuelle constante (en pixels écran)
        _uiSize = TargetScreenSize * s;

        StateHasChanged();
    }
}
